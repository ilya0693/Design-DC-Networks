# _Проектная работа_

## _Проектирование сетевой фабрики на основне VxLAN EVPN_

_Цель проекта:_ Проектирование и конфигурирование VxLAN EVPN фабрики между двумя географически распределенными ЦОД с использованием оборудования производителя Juniper.

_Задачи проекта:_
1.	Требования при проектировании ЦОД’ов.
2.	Описание архитектуры ЦОД
*	Описание Underlay сети и его конфигурация в рамках одного POD’а.
*	Описание Overlay сети и его конфигурация в рамках одного POD’а.
*	Реализация VXLAN/EVPN фабрики в Junos (L2VNI и L3VNI) в рамках одного POD’а.
3.	Организация внешних подключений или стык с вышестоящим провайдером и их резервирование.
4. DCI или растягивание VLAN между несколькими ЦОД
* Обеспечение IP связности между Lo адресами оборудования разных ЦОД в Underlay
* Обеспечение связности между ЦОД в Overlay.
5. Кратко про взаимодействие с оборудованием безопасности (NGFW, криптошлюзы, etc.)
6. Общие правила и рекомендации по эксплуатации сети (здесь описывается как назначать ASN, VNI, IP-адреса Lo интерфейсов, значение MTU, наименование оборудования и т.д.).

### _Введение_

В данном проекте отражены элементы Высокоуровневого (High Level Design) и Низкоуровневого дизайна (Low Level Design) сети передачи данных Центра Обработки Данных (ЦОД). Описывается рекомендуемая архитектура и шаблоны конфигурации для построения ЦОД на базе оборудования Juniper Networks. Данный проект является попыткой создать документ, который можно было бы использовать при проектировании сети ЦОД на базе оборудования Juniper Networks, а потому, некоторые моменты могут быть упущены или не учтены.

### _1. Требования при проектировании ЦОД’ов_

Рассмотрим ситуацию, когда необходимо создать инфраструктуру ЦОД на двух площадках, находящихся в городе Москва и городе Ставрополь, а к проектированию ЦОД предъявляют следующие требования:

* Требования по использованию архитектуры фабрики коммутации с распределённой плоскостью управления;
* Требования по расположению L3-маршрутизации ЦОД на граничных маршрутизаторах;
* Соединение ЦОД через вышестоящего провайдера;
* Общие требования по отказоустойчивости решения на каждом уровне ЦОД;
* Требования к масштабированию ЦОД по количеству коммутаторов и пропускной способности;
* Требования по балансировке и оптимальному прохождению трафика в ЦОД.

### _2. Описание архитектуры ЦОД_
На рисунке ниже представлена архитектура ЦОД, которая разбита на на следующие структурные блоки:
* Блок фабрики коммутации;
* Блок граничных маршрутизаторов и взаимодействия с удалёнными площадками;
* Блок межсетевых экранов;
* Блок подключения серверов;
* Блок подключения устройств L4-L7 сервисов.

![alt-текст](https://github.com/ilya0693/Design-DC-Networks/blob/main/project%20work/%D0%90%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0.drawio.png "Архитектура ЦОД")

В данном проекте блоки межсетевых экранов и устройств L4-L7 сервисов подробно рассматриваться не будут, остальные блоки либо детально (блоки фабрики коммутации и граничных маршрутизаторов), либо частично (блок подключения серверов) будут рассмотрены.

В силу требований по расположению VXLAN L3 GW функционала на BR, BR маршрутизаторы участвуют сразу в блоке фабрики коммутации и блоке граничных маршрутизаторов.

На рисунке ниже представлена физическая топология ЦОДа в г. Москва. Предполагается, что в г. Ставрополь физическая топология ЦОДа будет проектироваться идентично, но, в рамках данного проекта физическая топология упрощена из-за ограничений виртуального стенда.

![alt-текст](https://github.com/ilya0693/Design-DC-Networks/blob/main/project%20work/%D0%A4%D0%B8%D0%B7%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F%20%D1%81%D1%85%D0%B5%D0%BC%D0%B0.drawio.png "Физическая схема сети ЦОД")

На данной схеме все SPINE и LEAF соединены агрерированными интерфейсами, каждый из которых состоит из двух портов 10GE. BR соединены со Spine обычными неагрегированными портами 10 GE.

BR подключаются портами 1GE к вышестоящему провайдеру. Через вышестоящего провайдера подключаются клиентские VRF, а также через неё выполняется соединение Underlay для связности между несколькими ЦОД (Data Center Interconnect – DCI). BR дополнительно соединены друг с другом прямым интерфейсом. Этот интерфейс не является частью EVPN-фабрики, он используется для резервирования через MPLS L3VPN-стыков с вышестоящим провайдером.

_Примечание:_ На практике должны использоваться высокоскоростные интерфейсы, но в рамках проекта мы ограничены их скоростью из-за ограничений виртуальных устройств.

К LEAF-коммутаторам подключаются сервера. К BLEAF подключаются сервера и блок безопасности, состоящий из межсетерых экранов и VPN-шлюзов. Фактически, с точки зрения
шаблонов конфигурации, BLEAF не отличаются от LEAF, поэтому далее они будут называться просто LEAF-коммутаторами.

Для построения VxLAN EVPN фабрики используются следующие технологии:

**_EVPN (Ethernet over VPN)_** - технология, обеспечивающая передачу L2 трафика через WAN каналы связи (не имеющие прямой связности L2). Данная технология реализуется с использованием взаимодействия следующих протоколов:
–	BGP - информация о месторасположении узла-оконечного устройства с точки зрения EVPN;
–	VXLAN - передача L2 сегментов в инкапсулированном виде через IP/UDP;

**_BGP_** — Протокол динамической маршрутизации. Протокол BGP имеет уникальную (относительно иных протоколов маршрутизации) возможность передавать расширенную информацию в данных Multiprotocol BGP (MP-BGP). В сети ЦОДа данная возможность используется для обеспечения работы технологии EVPN: через протокол BGP между коммутаторами происходит обмен следующими данными по местонахождению узлов-клиентов EVPN:
  *	IP адреса устройств в EVPN;
  *	MAC адреса устройств в EVPN;
  *	За каким устройством (с точки зрения топологии BGP) находятся узлы-клиенты сети EVPN, на какое устройство следует отправлять инкапсулированные VXLAN пакеты для целевого узла.

**_VxLAN_** — технология инкапсуляции L2 фреймов в IP пакеты (UDP протокол). Технология стандартизирована в RFC7348. VXLAN не обеспечивает шифрования данных. Каждый VXLAN идентифицируется уникальным VNID (Virtual Network ID). VXLAN предоставляет следующие возможности:
  *	24 бит VNID (более 16 млн уникальных ID);
  *	Передача L2 трафика через L3 сети (MAC in UDP);
  *	Совместно с EVPN, BGP обеспечивается целевая доставка L2 фреймов получателю: минимизируется количество широковещательных фреймов через WAN каналы связи;
  *	Если L3 Underlay сеть обеспечивает балансировку между несколькими WAN каналами связи, то VXLAN (аналогично любому другому UDP трафику) может использовать возможности балансировки трафика для обеспечения равномерной нагрузки каналов связи;
  *	Использует один порт UDP/4789 для входящих пакетов (для более равномерной балансировки инкапсулированного трафика транспортная сеть [Underlay] должна обеспечивать балансировку по UDP порту источника, назначения).

### _2.1. Описание Underlay сети и его конфигурация в рамках одного POD’а_

Основным условием для сигнализации VXLAN-туннелей и обмена EVPN-маршрутами является IP-связность между всеми VTEP (точками терминации VXLAN), а именно между loopback-адресами коммутаторов ЦОД. В контексте ЦОД для организации IP-связности рекомендуется использовать архитектуру IP Fabric (RFC7938, Use of BGP for Routing in Large-Scale Data Centers), которая основывается на Clos-топологии (также известной как Spine&Leaf) и использовании протокола eBGP для сигнализации маршрутной информации. Также можно использовать протоколы семейства IGP (ISIS или OSPF) для распространения маршрутов loopback, но выбор в пользу eBGP для Underlay был сделан из-за гибких возможностей маркировки и фильтрации BGP-маршрутов. Для обеспечения балансировки в IP фабрике используется функция eBGP Multipath с включенной опцией multiple-as на основе длины атрибута AS_PATH. Таким образом, трафик между парой LEAF-коммутаторов будет всегда балансироваться через оба SPINE-коммутатора. На рисунке ниже представлена топология Underlay для обоих ЦОД.

![alt-текст](https://github.com/ilya0693/Design-DC-Networks/blob/main/project%20work/Underlay.drawio.png "Underlay топология ЦОД")

Ниже представлен шаблон для конфигурации Underlay











### _6. Общие правила и рекомендации по эксплуатации сети_
В данном разделе описаны правила именование площадок и устройств. Также в данном разделе описано, как назначать ASN, Lo интерфейсы, MTU, VNI и т.д. Раздел создан с целью упростить понимание архитектуры и процессы эксплуатации оборудования, а также облегчить процесс поиска неполадок. 

#### _6.1. Правила обозначения площадок_
Для того, чтобы упростить понимание, на какой площадке находится ЦОД ему назначают уникальный идентификатор **_dxx_**, где **_d_** расшифровывается как Data Center, а xxx - значение от 1 до 999. В нашем случае каждой площадке присваиваются следующие номера:

* d77 - г. Москва;
* d26 - г. Ставрополь.

В данном примере значения xxx выбраны исходя из их номера региона. Используя номера регионов для обозначения площадок ЦОД можно будет, практически, не "подглядывая" в документацию, определить, в каком городе или регионе расположен ЦОД. Если же в рамках одного региона будут располагаться 2 или 3 ЦОДа, то к значению региона прибавляется +100. Например, если в Москве будут расположены 2 или 3 ЦОДа, то второму ЦОДу будет присвоен идентификатор d177, а третьему - d277.

#### _6.2. Правила именования оборудования_
Для назначения наименования устройства (hostname) предлагается использовать следующее обозначение:
{site_name}(3)-{role}(2-5)-{rack}(3)-{device_id}(2), 

где

{site_name} - дентификатор площадки, на которой установлено устройство, длина – 3 символа, используемые символы: a-z, 0-9, нижний регистр. В рамках данного проекта используются площадки с кодами d77 и d26.

{role} - идентификатор роли устройства в ЦОД, длина – 2-5 символов, используемые символы: 0-9, a-z, нижний регистр. В рамках проектной работы используются следующие
идентификаторы устройств leaf, spine, br.

{rack} - идентификатор стойки, длина – 3 символа, используемые символы: 0-9, r, нижний регистр. Например, если устройство расположено в 5 стойке, то его номер будет r05.

{device_id} - уникальный идентификатор устройства данной роли в ЦОД.

Например, d77-leaf-r01-sw01 расшифровывается как Leaf-коммутатор с id=1 на площадке d77 (Москва) в стойке 1.

Использование данного правила значительно успростит понимание, к какому оборудованию вы подключены и в каком ЦОДе оно расположено.

#### _6.3. План адресации и нумерации ASN_

При распределении всей адресной информации между оборудованием ЦОД предлагается ввести таблицу с числовым ID каждого из устройств. Тогда вычисление необходимых значений адресных переменных будет осуществляться следующим образом: { parameter_space } + { device_id }. Это удобно при использовании средств автоматизации при генерации шаблонов конфигурации и выполнении проверочных тестов.

Таблица 1 - Таблица соответствия hostname и Device ID для ЦОД d77
|Hostname            |Device ID |
|--------------------|----------|
|d77-spine-r01-sw01  |1         |
|d77-spine-r01-sw02  |2         |
|d77-leaf-r11-sw01   |11        |
|d77-leaf-r12-sw02   |12        |
|d77-leaf-r13-sw03   |13        |
|d77-leaf-r14-sw04   |14        |
|d77-br-r02-br01     |4         |
|d77-br-r02-br02     |5         |

Таблица 2 - Таблица соответствия hostname и Device ID для ЦОД d26
|Hostname            |Device ID |
|--------------------|----------|
|d26-spine-r01-sw01  |1         |
|d26-spine-r01-sw02  |2         |
|d26-leaf-r11-sw01   |11        |
|d26-leaf-r12-sw02   |12        |
|d26-leaf-r13-sw03   |13        |
|d26-leaf-r14-sw04   |14        |
|d26-br-r02-br01     |4         |
|d26-br-r02-br02     |5         |

При добавлении нового оборудования в ЦОД необходимо назначить следующий свободный ID из соответствующего диапазона.

В рамках данного проекта разработано следующее распределение IP подсетей:
* 10.x.0.0/24 – диапазон для выделения адресов loopback коммутаторов ЦОД;
* 10.x.1.0/24 – диапазон для выделения адресных префиксов Point-to-Point линковых подсетей (длина префиксов /31);
* 10.x.253.0/25 - диапазон для выделения под mgmt IP-адреса коммутаторов.

Выделять 2 октет для сетей/подсетей рекомендуется исходя из номера площадки ЦОД. Например, если ЦОДу в г. Москва присвоен номер d77, то общая сеть у нее будет 10.77.0.0/16, которая, далее, разбивается на подсети. В случае назначения 3 октета закономерность отсутствует. Если возникнет ситуация, что в рамках одного региона у организации 2 ЦОДа, то второму ЦОДу 2 октет назначается по правилу № региона + 100. Например, в случае Москвы общая сеть 2 ЦОДа будет 10.177.0.0/16. Данное правило выделения 2 октета для сети не распространяется на регионы со значением выше 55. Например, если в Москве расположено 3 ЦОДа, то третьему ЦОДу уже не получится назначить во 2 октет значение 277. Следовательно, для 3 ЦОДа в качестве 2 октета выбираем любое свободное число, главное, чтобы оно не пересекалось с адресацией в других регионах. Как правило, такие исключения бывают редко, так как не часто встретишь ситуацию, когдва в рамках одного региона строят более 2х ЦОДов.

Что касается выделения последнего октета для Loopback и Mgmt интерфейса, то вычисление происходит путем прибавления ID к последнему октету адреса подсети, а MGMT-адреса путем прибавления ID+10 к последнему октету адреса подсети. Например, для d77-leaf-r11-sw01 с id=11 loopback IP равен 10.77.0.11. А MGMT-адрес равен 10.77.0.21. Исключением из предлагаемых правил генерации IP-адресов являются адреса BR устройств, так как данные устройства имеют как внешнюю, так и частную адресацию.

Для удобства нумерации используется 32-битные приватные ASN32 вида 42077000 + { device_id }(2) для d77 и 42026000 + { device_id }(2) для d26. Для device_id, состоящих из одного символа, слева добавляется ноль для сохранения формата записи. Для Overlay используются приватные ASN16:
* d77 – AS65277;
* d26 – AS65226.

Закономерности в выборе приватной ASN16 нет.

Как итог, в таблице 3, 4 представлен план адресации и нумерации ASN для Underlay

Таблица 3 - План адресации и нумерации ASN для d77
|Hostname            |mgmt IP                |Loopback               |Underlay AS  |Underlay link Spine-1 (subnet)|Underlay link Spine-2 (subnet)|
|--------------------|-----------------------|-----------------------|-------------|------------------------------|------------------------------|
|d77-spine-r01-sw01  |10.77.253.11/25        |10.77.0.1/32           |4207700001   |10.77.1.0/25                  |                              |
|d77-spine-r01-sw02  |10.77.253.12/25        |10.77.0.2/32           |4207700002   |                              |10.77.1.128/25                |
|d77-leaf-r11-sw01   |10.77.253.21/25        |10.77.0.11/32          |4207700011   |10.77.1.0/31                  |10.77.1.128/31                |
|d77-leaf-r12-sw02   |10.77.253.22/25        |10.77.0.12/32          |4207700012   |10.77.1.2/31                  |10.77.1.130/31                |
|d77-leaf-r13-sw03   |10.77.253.23/25        |10.77.0.13/32          |4207700013   |10.77.1.4/31                  |10.77.1.132/31                |
|d77-leaf-r14-sw04   |10.77.253.24/25        |10.77.0.14/32          |4207700014   |10.77.1.6/31                  |10.77.1.134/31                |
|d77-br-r02-br01     |10.77.253.4/25         |10.77.0.4/32           |4207700004   |10.77.1.120/31                |10.77.1.248/31                |
|d77-br-r02-br02     |10.77.253.7/25         |10.77.0.5/32           |4207700005   |10.77.1.122/31                |10.77.1.250/31                |

Таблица 4 - План адресации и нумерации ASN для d26
|Hostname            |mgmt IP                |Loopback               |Underlay AS  |Underlay link Spine-1 (subnet)|Underlay link Spine-2 (subnet)|
|--------------------|-----------------------|-----------------------|-------------|------------------------------|------------------------------|
|d26-spine-r01-sw01  |10.26.253.11/25        |10.26.0.1/32           |4202600001   |10.26.1.0/25                  |                              |
|d26-spine-r01-sw02  |10.26.253.12/25        |10.26.0.2/32           |4202600002   |                              |10.26.1.128/25                |
|d26-leaf-r11-sw01   |10.26.253.21/25        |10.26.0.11/32          |4202600011   |10.26.1.0/31                  |10.26.1.128/31                |
|d26-leaf-r12-sw02   |10.26.253.22/25        |10.26.0.12/32          |4202600012   |10.26.1.2/31                  |10.26.1.130/31                |
|d26-leaf-r13-sw03   |10.26.253.23/25        |10.26.0.13/32          |4202600013   |10.26.1.4/31                  |10.26.1.132/31                |
|d26-leaf-r14-sw04   |10.26.253.24/25        |10.26.0.14/32          |4202600014   |10.26.1.6/31                  |10.26.1.134/31                |
|d26-br-r02-br01     |10.26.253.4/25         |195.228.111.1/32       |4202600004   |10.26.1.120/31                |10.26.1.248/31                |
|d26-br-r02-br02     |10.26.253.7/25         |195.228.111.2/32       |4202600005   |10.26.1.122/31                |10.26.1.250/31                |

#### _6.4. Таблица значений VNI, используемых на площадках d77 и d26_
Значения VNI в обоих ЦОД должны быть уникальными. Ниже представлены рекомендуемые значения VNI для каждой из площадок, а также значения для «растянутых» VLAN:
* 77xxxx – локальные VLAN для d77, где xxxx – значение VLAN. В случае, если значение VLAN – это трёх- или менее значное число, то к этому значению слева дописывается
необходимое количество нулей для сохранения формата записи номеров VNI. Например, 773011 (VLAN3011) и 770018 (VLAN18);
* 26yyyy – локальные VLAN для d26. Например, 260025 (VLAN25) и 263500 (VLAN3500);
* 65zzzz – «растянутые» VLAN между d77 и d26. Например, 650048 (VLAN48) или 650005 (VLAN 5).
